<!DOCTYPE html>
<meta charset="utf-8">
<title>snooplace - a /r/place timelapse and stats</title>
<meta name="keywords" content="reddit, timelapse, stats, april, fools, joke" /><meta name="description" content="a /r/place timelapse and stats" />
<!-- TODO: Refactor with React. -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/semantic-ui/2.2.10/semantic.min.css">
<script src="https://cdn.jsdelivr.net/semantic-ui/2.2.10/semantic.min.js"></script>
<style>
body{
margin: 0;
}

#canvas{                    image-rendering: -moz-crisp-edges;         /* Firefox */
                   image-rendering:   -o-crisp-edges;         /* Opera */
                   image-rendering: -webkit-optimize-contrast;/* Webkit (non-standard naming) */
                   image-rendering: crisp-edges;
-ms-interpolation-mode: nearest-neighbor;  /* IE (non-standard property) */ 
margin:0 auto; width: 1000px; display: block;}
.overlay {
  fill: none;
  pointer-events: all;
}

.main {padding-top: 100px;}
#color_stats{ text-align: center; }
</style>
<body>


  <div class="ui fixed inverted menu">
    <div class="ui container">
      <a href="#" class="header item">
        snooplace
      </a>
      <a href="#" class="item">Home</a>
    </div>
  </div>
  <div class="ui main text container">
  <div class="ui icon message">
  <i class="inbox icon"></i>
  <div class="content">
    <div class="header">
      welcome to snooplace
    </div>
    <p>This is a full timelapse of <a href="https://reddit.com/r/place/">/r/place.</a></p> Use the buttons to navigate through time, although the map might not load if you go to the future (or if the server crashed during specific time).
  </div>
</div>

  <div class="ui segment">
  <button class="ui labeled icon button" onclick="ndraw(-10)"><i class="left arrow icon"></i>10 min before</button> 
<button class="ui labeled icon button" onclick="ndraw(-1)"><i class="left arrow icon"></i>1 min before</button> 
<button class="ui labeled icon button" onclick="ndraw(1)"><i class="right arrow icon"></i>1 min after</button>
<button class="ui labeled icon button" onclick="ndraw(10)"><i class="right arrow icon"></i>10 min after</button>
  <div class="ui active dimmer" id="loading">
    <div class="ui text loader">Loading</div>
  </div>
  <p></p>
</div>
<br/>
</div>
<div class="ui segment" id="color_stats">
</div>
<canvas width="1000" height="1000" id="canvas"></canvas>
<script>
window.the_time = Math.round(new Date().getTime() / (1000 * 60));
var width = 1000,
    height = 1000;

var canvas = document.getElementById("canvas").getContext("2d");

draw(the_time - 1);

function ndraw(n){
	window.the_time+= n;
	draw(window.the_time);
}

function zoom() {
  canvas.save();
  canvas.clearRect(0, 0, width, height);
  canvas.translate(d3.event.translate[0], d3.event.translate[1]);
  canvas.scale(d3.event.scale, d3.event.scale);
}

function decode(e, r, i, s) {
	r || (r = (new Uint32Array(e.buffer,0,1))[0],
	e = new Uint8Array(e.buffer,4));
	for (var t = 0; t < e.byteLength; t++)
		i[s + 2 * t] = e[t] >> 4,
		i[s + 2 * t + 1] = e[t] & 15;
	s += e.byteLength * 2
}
var palette = ["#FFFFFF", "#E4E4E4", "#888888", "#222222", "#FFA7D1", "#E50000", "#E59500", "#A06A42", "#E5D900", "#94E044", "#02BE01", "#00D3DD", "#0083C7", "#0000EA", "#CF6EE4", "#820080"];
function draw(t) {
	document.getElementById('loading').style.display = 'block';
	var oReq = new XMLHttpRequest();
	oReq.responseType = 'arraybuffer';
	oReq.addEventListener("load", function() {
		console.log(this.response);
		var sx = new Uint8Array(this.response);
		var r, i = new Uint8Array(1000 * 1000);
		var s = 0;
		decode(sx, r, i, s);
		var out = new Uint8ClampedArray(4 * 1000 * 1000);
		z =0;
		var paletteCount = {};
		var sum = 0;
		for(var p = 0; p < palette.length; p++){
			paletteCount[palette[p]] = 0;
		}
		for(var l = 0; l < i.length; l++){
			var col = palette[i[l]];
			paletteCount[col]+= 1;
			sum++;
			out[z] = parseInt(col[1] + col[2], 16);
			z++;
			out[z] = parseInt(col[3] + col[4], 16);
			z++;
			out[z] = parseInt(col[5] + col[6], 16)
			z++;
			out[z] = 255;
			z++;
		}
		var colorHTML = '<h2>Color distribution</h2>';
		for(var m = 0; m < palette.length; m++){
			colorHTML+= '<span style="color: ' + palette[m] + '">' + ((paletteCount[palette[m]]/sum) * 100).toFixed(2) + '%</span> ';
		}
		document.getElementById('color_stats').innerHTML = colorHTML;
		canvas.putImageData(new ImageData(out, 1000, 1000), 0, 0);
		document.getElementById('loading').style.display = 'none';
		
	});
	oReq.open("GET", "https://storage.googleapis.com/redditplace/" + t + ".bin");
	oReq.send();
}

</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-77420284-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>